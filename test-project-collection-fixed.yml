---
- name: Test Collection from Project Structure (Fixed)
  hosts: 127.0.0.1
  connection: local
  gather_facts: false
  environment:
    ANSIBLE_COLLECTIONS_PATH: "/runner/project/ansible_collections:/runner/requirements_collections:/home/runner/.ansible/collections:/usr/share/ansible/collections"
  collections:
    - keepersecurity.keeper_secrets_manager

  tasks:
    - name: Debug collection paths
      debug:
        msg:
          - "Current working directory: {{ ansible_env.PWD | default('unknown') }}"
          - "Collection path: {{ ansible_env.ANSIBLE_COLLECTIONS_PATH | default('not set') }}"

    - name: Test keeper_info module (should work now)
      keeper_info:
      register: info_result
      failed_when: false

    - name: Show info result
      debug:
        var: info_result

    - name: Test keeper_get module
      keeper_get:
        uid: "test-uid-should-fail-but-module-should-be-found"
      register: get_result
      failed_when: false

    - name: Show get result
      debug:
        var: get_result

    - name: Success message
      debug:
        msg:
          - "âœ… Collection is working from project structure!"
          - "Modules are being found and loaded properly"
          - "You can now use keepersecurity.keeper_secrets_manager modules"
      when: info_result is defined or get_result is defined